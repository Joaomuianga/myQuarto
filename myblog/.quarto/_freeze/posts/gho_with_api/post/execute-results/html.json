{
  "hash": "7bce61e08bbbb26b9cbf7de9e894da67",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"API with R to Extract data from the WHO Global Health Observatory (GHO) \"\nlisting:\n  contents: posts/gho_with_api\n  sort: \"date desc\"\n  type: default\n  categories: true\n  sort-ui: false\n  filter-ui: false\n  fields: [image, date, title, reading-time, description]\npage-layout: full\ntitle-block-banner: false\nimage: \"api.jpg\"\ndate: \"2024-06-28\"\ncategories: [R, API, Summary Table, GHO OData API]\ndescription: \"How to Extract a list of indicators available in World Health Organization - Global Health Observatory (GHO) via API and  create a summary table.\"\n\nexecute: \n  message: false\n  warning: false\n  \n  editor_options:\n    chunk_output_type: console\n    \nformat: \n  html:\n    code-fold: true\neditor: visual\n---\n\n::: {.cell}\n\n:::\n\n\n\n\n# Context / Purpose\n\n[The Global Health Observatory (GHO)](https://www.who.int/data/gho) data repository is WHO's gateway to health-related statistics. It provides access to over 1000 indicators on priority health topics including mortality and burden of diseases, the Millenium Development Goals and more. They are updated as more recent or revised data become available.\n\nIn this scenario I will create a function to extract the indicator of *Nutrition - Prevalence of wasted children under 5 years of age* and summarise a table showing the total of countries by region that have their most recent value from the year of 2001 to 2020.\n\n# Install packages\n\nInstall and run packages, they are the fundamental units of reproducible R code. In this case we will run packages for external connections and reproduction of summarized tables.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\npacman::p_load(\n  rio,              # Import and export files\n  here,             # File pathways\n  jsonlite,         # Read JSON file in R\n  httr,             # Request object in URL or HTML (GET(), POST())\n  glue,             # Interpret string literals that are small, fast, and dependency-free\n  janitor,          # Data cleaning and tables\n  lubridate,        # Working with dates\n  flextable,        # mMke HTML tables \n  officer,          # hHlper functions for tables\n  tidyverse         # Data management and visualization\n)\n```\n:::\n\n\n\n\n# Function to extract data in the GHO OData API\n\n-   First let's define the global variables, this involves setting the URL, and indicators interested. The Indicator code is: *Prevalence of wasted children under 5 years of age*.\n\n-   Second, we will create a function that requests and searches the data on the GHO website for R and converts JSON files into a data frame.\n\nCode source: Thanks [Kirstin](https://medium.com/@kirstin.lyon/connect-to-global-health-observatory-who-data-api-with-r-fef4315693a1) for useful tutorial.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\n# Global variable\nurl_base <- \"https://ghoapi.azureedge.net/api/\" \n\n# Declare the type of indicators \nindicator_text <- \"prevalence\"      \nindicator_text_wasted <- \"Wasting prevalence among children under 5 years of age\"\nindicator <- \"NUTRITION_WH_2\"\n\n# The function convert a JSON in URL to tibble\nconvert_JSON_to_tbl <- function(url){\n  data <- GET(url)                                                    # Get a url\n  data_df <- fromJSON(content(data, as = \"text\", encoding = \"utf-8\")) # Convert R object to JSON\n  data_tbl <-  map_if(data_df, is.data.frame, list) %>%               # Takes a predicate function.p \n    as_tibble %>%                                                     # Turn the object such as a data frame\n    unnest(cols = c(value)) %>%                                       # Expands a list-column containing dataframe into rows and columns\n    select(-'@odata.context')                                         \n}\n\n\n###### Exploring the data\n\n# URL will provide you with the list of indicators\nall_indicators <-  convert_JSON_to_tbl(glue(url_base,\"Indicator\")) %>% \n  select(-Language)\n\n####### Create a vector for the  indicator requested\n\n# Get the indicator through code\nget_indicator_code <- all_indicators %>% \n  filter(grepl(indicator, IndicatorCode, ignore.case = TRUE))  # grepl search for matches to argument pattern\n\n# Get the indicator through text \nget_indicator_text <- all_indicators %>% \n  filter(grepl(indicator_text, IndicatorName, ignore.case = TRUE))\n\n# Get the indicator through a word \"Wasting\" \nget_indicator_text_wasted <- all_indicators %>% \n  filter(grepl(indicator_text_wasted, IndicatorName, ignore.case = TRUE))\n\n# Join the tables \nindicators <- get_indicator_code %>% \n  union(get_indicator_text) %>% \n  union(get_indicator_text_wasted)\n\n# Show in a list the names of indicator codes\nindicator_codes <- get_indicator_code %>% \n  pull(IndicatorCode)\n\n# Pull data and Convert to a List, however only extract data of interest\n# Each indicator has its own table in the WHO GHO, but in this case we would like to have one table \"Nutrition_WH\"\nindicator_data <- map(indicator_codes, function(code){       # return a list   \n  response <- GET(\n    glue(url_base, code))                                    # get URL and the 2 indicators codes found\n  content(response, \"text\")\n})\n\n\n# Converts the list to tibble with one column per field\nindicator_data_tbl <- map_dfr(indicator_data, ~ fromJSON(.x, \n                                                         simplifyVector = TRUE)  %>%\n                              as_tibble()  %>%\n                              unnest(cols = everything())) \n\nexport(indicator_data_tbl, here(\"data\", \"data_table_raw.csv\"))\n```\n:::\n\n\n\n\n# Check the data\n\nIt's always good to check the table, use the `skimr::skim(dataset)` function it provides summary statistics about variables in data frames, however let see only 5 rows and all columns.\n\n\n\n\n\n\n\n\n\n\n\n# Data Cleaning\n\nTime to clean the data_table. let's use the functions from the tidyverse family of R packages, we just need to rename interested columns using the `rename()` function and reorder the columns, keeping the original ones at the end.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\ndata_table <- indicator_data_tbl %>%\n  # Clean column names\n  clean_names() %>%\n  # Rename columns \n  rename(year = time_dim,\n         numeric_value = numeric_value,\n         high_value = high,\n         low_value = low,\n         country_code = spatial_dim,\n         region_code = parent_location_code,\n         region_name = parent_location,\n         indicator_code = id,\n         indicator_name = indicator_code,\n         source = odata_context) %>% \n  # Reorder the position of interest's columns\n  select(indicator_code, indicator_name, region_code, region_name, year, country_code, low_value, high_value, numeric_value, everything())\n```\n:::\n\n\n\n\n# Summary Table\n\nLet's create a nice table to show how many countries have their most recent value in the year ranges 2001-2005, 2006-2010, 2011-2015, 2016-2020.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\ndata_table <- import(here(\"data\", \"nutrition_dataset.csv\"))\n\nborder_style <- officer::fp_border(color=\"black\", width=1)\n\n data_table %>%\n  filter(year > 2000, value>0) %>%\n  mutate(range = case_when(\n    year <2006  ~ \"2001-2005\",\n    year >2005 & year <2011 ~ \"2006-2010\",\n    year >2010 & year <2016 ~ \"2011-2015\",\n    year >2015 & year <2021 ~ \"2016-2020\"\n  )) %>%\n  select(range, region_name, country_code, value) %>%\n   \n  distinct(range, country_code, region_name)%>%\n  tabyl(region_name, range, show_na = FALSE)%>%\n  adorn_totals() %>%\n  adorn_percentages(denominator = \"col\") %>%\n  adorn_pct_formatting() %>%\n  adorn_ns(position = \"front\") %>%\n  flextable::qflextable() %>% \n  autofit() %>%\n    \n  add_header_row(\n    top = TRUE,\n    values = c(\"WHO Region\",\n               \"Total of Countries by Year Range\",\n               \"\",\n               \"\",\n               \"\")) %>%\n  set_header_labels(\n    region_name = \"\") %>%\n  merge_at(i = 1, j= 2:5, part = \"header\")%>%\n  border_remove() %>%\n  theme_booktabs()%>%\n  vline(part = \"all\", j=1, border = border_style)%>%\n  align(align = \"center\", j = c(2:5), part = \"all\") %>%\n  fontsize(i = 1, size = 12, part = \"header\") %>%\n  bold(i = 1, bold = TRUE, part = \"header\") %>%\n  bold(i = 7, bold = TRUE, part = \"body\") %>%\n  bg(part = \"body\", bg = \"gray95\")\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"tabwid\"><style>.cl-9be9cf48{}.cl-9be69f1c{font-family:'Helvetica';font-size:12pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-9be69f26{font-family:'Helvetica';font-size:11pt;font-weight:normal;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-9be69f30{font-family:'Helvetica';font-size:11pt;font-weight:bold;font-style:normal;text-decoration:none;color:rgba(0, 0, 0, 1.00);background-color:transparent;}.cl-9be7e804{margin:0;text-align:left;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-9be7e805{margin:0;text-align:center;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);padding-bottom:5pt;padding-top:5pt;padding-left:5pt;padding-right:5pt;line-height: 1;background-color:transparent;}.cl-9be7f2b8{width:1.839in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2b9{width:1.117in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2c2{width:1.202in;background-color:transparent;vertical-align: middle;border-bottom: 0 solid rgba(102, 102, 102, 1.00);border-top: 1.5pt solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2c3{width:1.839in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2c4{width:1.117in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2c5{width:1.202in;background-color:transparent;vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(102, 102, 102, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2cc{width:1.839in;background-color:rgba(242, 242, 242, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2cd{width:1.117in;background-color:rgba(242, 242, 242, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2ce{width:1.202in;background-color:rgba(242, 242, 242, 1.00);vertical-align: middle;border-bottom: 0 solid rgba(0, 0, 0, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2cf{width:1.839in;background-color:rgba(242, 242, 242, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 1pt solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2d6{width:1.117in;background-color:rgba(242, 242, 242, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 1pt solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}.cl-9be7f2d7{width:1.202in;background-color:rgba(242, 242, 242, 1.00);vertical-align: middle;border-bottom: 1.5pt solid rgba(102, 102, 102, 1.00);border-top: 0 solid rgba(0, 0, 0, 1.00);border-left: 0 solid rgba(0, 0, 0, 1.00);border-right: 0 solid rgba(0, 0, 0, 1.00);margin-bottom:0;margin-top:0;margin-left:0;margin-right:0;}</style><table data-quarto-disable-processing='true' class='cl-9be9cf48'><thead><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-9be7f2b8\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f1c\">WHO Region</span></p></th><th  colspan=\"4\"class=\"cl-9be7f2b9\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f1c\">Total of Countries by Year Range</span></p></th></tr><tr style=\"overflow-wrap:break-word;\"><th class=\"cl-9be7f2c3\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\"></span></p></th><th class=\"cl-9be7f2c4\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">2001-2005</span></p></th><th class=\"cl-9be7f2c5\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">2006-2010</span></p></th><th class=\"cl-9be7f2c5\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">2011-2015</span></p></th><th class=\"cl-9be7f2c5\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">2016-2020</span></p></th></tr></thead><tbody><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cc\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\">Africa</span></p></td><td class=\"cl-9be7f2cd\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">25  (28.1%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">35  (31.5%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">41  (36.3%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">35  (34.3%)</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cc\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\">Americas</span></p></td><td class=\"cl-9be7f2cd\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">18  (20.2%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">22  (19.8%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">20  (17.7%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">19  (18.6%)</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cc\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\">Eastern Mediterranean</span></p></td><td class=\"cl-9be7f2cd\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">13  (14.6%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">12  (10.8%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">15  (13.3%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">12  (11.8%)</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cc\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\">Europe</span></p></td><td class=\"cl-9be7f2cd\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">18  (20.2%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">15  (13.5%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">16  (14.2%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">14  (13.7%)</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cc\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\">South-East Asia</span></p></td><td class=\"cl-9be7f2cd\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">7   (7.9%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">11   (9.9%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">8   (7.1%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">10   (9.8%)</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cc\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f26\">Western Pacific</span></p></td><td class=\"cl-9be7f2cd\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">8   (9.0%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">16  (14.4%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">13  (11.5%)</span></p></td><td class=\"cl-9be7f2ce\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f26\">12  (11.8%)</span></p></td></tr><tr style=\"overflow-wrap:break-word;\"><td class=\"cl-9be7f2cf\"><p class=\"cl-9be7e804\"><span class=\"cl-9be69f30\">Total</span></p></td><td class=\"cl-9be7f2d6\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f30\">89 (100.0%)</span></p></td><td class=\"cl-9be7f2d7\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f30\">111 (100.0%)</span></p></td><td class=\"cl-9be7f2d7\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f30\">113 (100.0%)</span></p></td><td class=\"cl-9be7f2d7\"><p class=\"cl-9be7e805\"><span class=\"cl-9be69f30\">102 (100.0%)</span></p></td></tr></tbody></table></div>\n```\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/tabwid-1.1.3/tabwid.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/tabwid-1.1.3/tabwid.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}